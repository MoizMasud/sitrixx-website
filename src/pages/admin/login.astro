---
import MainLayout from '../../layouts/main.astro';
import { baseUrl } from '../../lib/base-url';
---

<MainLayout 
  title="Admin Login - Sitrixx"
  description="Login to Sitrixx admin dashboard"
>
  <div class="min-h-screen bg-background flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-md">
      <!-- Login form (show immediately) -->
      <div id="login-content">
        <div class="text-center mb-8">
          <a href={`${baseUrl}/`} class="inline-block">
            <h1 class="text-4xl font-black mb-2 tracking-tight bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
              Sitrixx
            </h1>
          </a>
          <p class="text-muted-foreground">Admin Portal</p>
        </div>

        <div id="login-container" class="bg-card border-2 rounded-3xl p-8 shadow-xl relative">
          <!-- Theme Toggle Button -->
          <div class="absolute top-6 right-6">
            <button
              id="theme-toggle"
              class="p-2 hover:bg-accent rounded-lg transition-colors"
              aria-label="Toggle theme"
            >
              <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
              </svg>
              <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </svg>
            </button>
          </div>

          <!-- Back Button -->
          <a 
            href={`${baseUrl}/`}
            class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors mb-6 group"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-1 transition-transform">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to Home
          </a>

          <h2 class="text-2xl font-bold mb-6 tracking-tight">Log In</h2>
          
          <!-- Error Message -->
          <div id="error-message" class="hidden mb-6 p-4 bg-destructive/10 border-2 border-destructive/50 rounded-xl">
            <p class="text-sm text-destructive font-medium"></p>
          </div>

          <!-- Success Message -->
          <div id="success-message" class="hidden mb-6 p-4 bg-green-500/10 border-2 border-green-500/50 rounded-xl">
            <p class="text-sm text-green-600 dark:text-green-400 font-medium"></p>
          </div>
          
          <form id="login-form" class="space-y-6">
            <div>
              <label for="login-email" class="block text-sm font-medium mb-2 text-foreground dark:!text-white">
                Email <span class="text-red-500">*</span>
              </label>
              <input
                type="email"
                id="login-email"
                name="email"
                required
                class="w-full px-4 py-3 rounded-xl border-2 bg-background text-foreground dark:!text-white focus:outline-none focus:ring-2 focus:ring-primary transition-all"
                placeholder="admin@sitrixx.com"
              />
            </div>

            <div>
              <label for="login-password" class="block text-sm font-medium mb-2 text-foreground dark:!text-white">
                Password <span class="text-red-500">*</span>
              </label>
              <input
                type="password"
                id="login-password"
                name="password"
                required
                class="w-full px-4 py-3 rounded-xl border-2 bg-background text-foreground dark:!text-white focus:outline-none focus:ring-2 focus:ring-primary transition-all"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>

            <div class="flex items-center text-sm">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="remember-me" class="rounded border-2" />
                <span class="text-muted-foreground">Remember me</span>
              </label>
            </div>

            <button
              type="submit"
              id="login-button"
              class="w-full bg-gradient-to-r from-primary to-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:opacity-90 transition-opacity shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              <svg id="button-spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span id="button-text" class="text-white">Log In</span>
              <span id="button-loading" class="hidden text-white">Logging in...</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';

    console.log('=== LOGIN PAGE SCRIPT LOADED ===');

    // Get baseUrl from data attribute
    const baseUrl = document.querySelector('html')?.dataset?.baseUrl || '';
    console.log('Base URL:', baseUrl);

    // Theme Toggle Logic
    const themeToggle = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    const html = document.documentElement;

    function updateThemeIcon(theme: string) {
      if (theme === 'dark') {
        sunIcon?.classList.remove('hidden');
        moonIcon?.classList.add('hidden');
      } else {
        sunIcon?.classList.add('hidden');
        moonIcon?.classList.remove('hidden');
      }
    }

    // Initialize theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
      html.classList.add('dark');
    }
    updateThemeIcon(savedTheme);

    themeToggle?.addEventListener('click', () => {
      const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      if (newTheme === 'dark') {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
      }
      
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    });

    // Prevent redirect loops
    let isRedirecting = false;

    // üîë Supabase Configuration
    const SUPABASE_URL = 'https://lmvymcncmmxtgfhkosmc.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_yeiYWuyhjZBBoSPcFRRKow__58efMlK';

    console.log('Creating Supabase client...');
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase client created');
    
    // Expose Supabase client globally for authFetch
    (window as any).supabaseClient = supabase;

    // Check for existing session in background (non-blocking)
    async function checkExistingSession() {
      try {
        console.log('Checking for existing session...');
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session && localStorage.getItem('sitrixx_token')) {
          // User is already logged in, redirect to admin
          console.log('‚úÖ Existing session found, redirecting to admin...');
          isRedirecting = true;
          window.location.replace(baseUrl + '/admin');
        } else {
          console.log('No existing session found');
        }
      } catch (error) {
        // Silent fail - user can still log in manually
        console.log('Session check failed:', error);
      }
    }

    checkExistingSession();

    const form = document.getElementById('login-form') as HTMLFormElement;
    const emailInput = document.getElementById('login-email') as HTMLInputElement;
    const passwordInput = document.getElementById('login-password') as HTMLInputElement;
    const loginButton = document.getElementById('login-button') as HTMLButtonElement;
    const buttonText = document.getElementById('button-text');
    const buttonLoading = document.getElementById('button-loading');
    const buttonSpinner = document.getElementById('button-spinner');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    console.log('Form elements:', {
      form: !!form,
      emailInput: !!emailInput,
      passwordInput: !!passwordInput,
      loginButton: !!loginButton
    });

    if (!form || !emailInput || !passwordInput) {
      console.error('‚ùå Login form elements not found');
      throw new Error('Login form elements not found');
    }

    // Helper functions
    function showError(message: string) {
      console.log('Showing error:', message);
      errorMessage?.classList.remove('hidden');
      const errorPara = errorMessage?.querySelector('p');
      if (errorPara) errorPara.textContent = message;
      successMessage?.classList.add('hidden');
    }

    function showSuccess(message: string) {
      console.log('Showing success:', message);
      successMessage?.classList.remove('hidden');
      const successPara = successMessage?.querySelector('p');
      if (successPara) successPara.textContent = message;
      errorMessage?.classList.add('hidden');
    }

    function hideMessages() {
      errorMessage?.classList.add('hidden');
      successMessage?.classList.add('hidden');
    }

    function setLoading(isLoading: boolean) {
      console.log('Setting loading state:', isLoading);
      loginButton.disabled = isLoading;
      if (isLoading) {
        buttonText?.classList.add('hidden');
        buttonLoading?.classList.remove('hidden');
        buttonSpinner?.classList.remove('hidden');
      } else {
        buttonText?.classList.remove('hidden');
        buttonLoading?.classList.add('hidden');
        buttonSpinner?.classList.add('hidden');
      }
    }

    console.log('Adding form submit listener...');
    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      
      console.log('üî• FORM SUBMITTED üî•');
      
      // Prevent double submission
      if (isRedirecting || loginButton.disabled) {
        console.log('‚ö†Ô∏è Preventing double submission');
        return;
      }

      hideMessages();

      const email = emailInput.value.trim();
      const password = passwordInput.value;

      console.log('Email:', email);
      console.log('Password length:', password.length);

      if (!email || !password) {
        showError('Please enter your email and password.');
        return;
      }

      console.log('üöÄ Attempting login for:', email);
      setLoading(true);

      try {
        console.log('Calling Supabase signInWithPassword...');
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        console.log('Supabase response:', { data, error });

        if (error) {
          console.error('‚ùå Login error:', error);
          showError('Login failed: ' + error.message);
          setLoading(false);
          return;
        }

        console.log('‚úÖ Login successful:', data);

        // Store session token for later API calls
        const accessToken = data.session?.access_token;
        if (accessToken) {
          console.log('Storing token in localStorage');
          localStorage.setItem('sitrixx_token', accessToken);
          localStorage.setItem('sitrixx_user', JSON.stringify(data.user));
        }

        showSuccess('Login successful! Redirecting...');
        isRedirecting = true;
        
        // Redirect to admin dashboard
        console.log('Redirecting to:', baseUrl + '/admin');
        setTimeout(() => {
          window.location.replace(baseUrl + '/admin');
        }, 500);

      } catch (err) {
        console.error('‚ùå Unexpected error:', err);
        showError('An unexpected error occurred. Please try again.');
        setLoading(false);
      }
    });

    console.log('‚úÖ Login form initialized successfully');
  </script>

  <!-- authFetch Helper (available globally after login) -->
  <script>
    const API_BASE = 'https://sitrixx-website-backend.vercel.app';

    /**
     * Wrap fetch to always send the Supabase JWT.
     * If there is no logged-in user, redirect to login.
     */
    async function authFetch(path: string, options: RequestInit = {}) {
      const supabase = (window as any).supabaseClient;
      if (!supabase) {
        console.error('Supabase client not found');
        throw new Error('Supabase not initialized');
      }

      // Get current session
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error('Error getting session', error);
        throw error;
      }

      const session = data.session;
      if (!session) {
        // Not logged in ‚Üí bounce them to login page
        window.location.href = '/admin/login';
        throw new Error('Not authenticated');
      }

      const token = session.access_token;

      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {}),
        Authorization: `Bearer ${token}`,
      };

      return fetch(`${API_BASE}${path}`, {
        ...options,
        headers,
      });
    }

    // Expose globally so admin pages / custom code can call it
    (window as any).authFetch = authFetch;
  </script>

  <style>
    /* Force white text on login button */
    #login-button,
    #login-button span {
      color: white !important;
    }

    /* Force white text in dark mode for inputs and labels */
    .dark #login-email,
    .dark #login-password,
    .dark label[for="login-email"],
    .dark label[for="login-password"] {
      color: white !important;
    }
  </style>
</MainLayout>

<script define:vars={{ baseUrl }}>
  // Store baseUrl in data attribute for the client script to access
  document.documentElement.dataset.baseUrl = baseUrl;
</script>
