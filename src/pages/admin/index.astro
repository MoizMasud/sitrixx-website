---
import MainLayout from '../../layouts/main.astro';
import AdminLayout from '../../components/AdminLayout';
import DashboardOverview from '../../components/DashboardOverview';
import { baseUrl } from '../../lib/base-url';

const API_BASE = 'https://sitrixx-website-backend.vercel.app';

// Fetch all data server-side
let dashboardData = {
  clients: [],
  leads: [],
  reviews: [],
  error: null as string | null
};

try {
  // Fetch clients
  const clientsRes = await fetch(`${API_BASE}/api/clients`);
  if (clientsRes.ok) {
    const clientsData = await clientsRes.json();
    // Handle both array and object with clients property
    dashboardData.clients = Array.isArray(clientsData) ? clientsData : (clientsData.clients || []);
  }

  // Fetch all leads and reviews for each client
  if (Array.isArray(dashboardData.clients)) {
    for (const client of dashboardData.clients) {
      try {
        // Fetch leads
        const leadsRes = await fetch(`${API_BASE}/api/leads?clientId=${encodeURIComponent(client.id)}`);
        if (leadsRes.ok) {
          const leadsData = await leadsRes.json();
          const leads = leadsData.leads || [];
          dashboardData.leads.push(...leads);
        }

        // Fetch reviews
        const reviewsRes = await fetch(`${API_BASE}/api/reviews?clientId=${encodeURIComponent(client.id)}`);
        if (reviewsRes.ok) {
          const reviewsData = await reviewsRes.json();
          const reviews = reviewsData.reviews || [];
          dashboardData.reviews.push(...reviews);
        }
      } catch (err) {
        console.error(`Error fetching data for client ${client.id}:`, err);
      }
    }
  }
} catch (err) {
  console.error('Error fetching dashboard data:', err);
  dashboardData.error = err instanceof Error ? err.message : 'Failed to load data';
}
---

<MainLayout 
  title="Admin Dashboard - Sitrixx"
  description="Sitrixx admin dashboard overview"
>
  <AdminLayout client:only="react" activePage="dashboard">
    <DashboardOverview client:only="react" initialData={dashboardData} />
  </AdminLayout>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Initialize Supabase Client -->
  <script>
    const { createClient } = window.supabase;
    const SUPABASE_URL = 'https://lmvymcncmmxtgfhkosmc.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_yeiYWuyhjZBBoSPcFRRKow__58efMlK';
    
    window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- authFetch Helper -->
  <script>
    const API_BASE = 'https://sitrixx-website-backend.vercel.app';

    /**
     * Wrap fetch to always send the Supabase JWT.
     * If there is no logged-in user, redirect to login.
     */
    async function authFetch(path, options = {}) {
      const supabase = window.supabaseClient;
      if (!supabase) {
        console.error('Supabase client not found');
        throw new Error('Supabase not initialized');
      }

      // Get current session
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error('Error getting session', error);
        throw error;
      }

      const session = data.session;
      if (!session) {
        // Not logged in â†’ bounce them to login page
        window.location.href = '/admin/login';
        throw new Error('Not authenticated');
      }

      const token = session.access_token;

      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {}),
        Authorization: `Bearer ${token}`,
      };

      return fetch(`${API_BASE}${path}`, {
        ...options,
        headers,
      });
    }

    // Expose globally so admin pages / custom code can call it
    window.authFetch = authFetch;
  </script>

  <!-- Authentication Guard Script -->
  <script define:vars={{ baseUrl }}>
    const token = localStorage.getItem('sitrixx_token');
    if (!token) {
      window.location.href = baseUrl + '/admin/login';
    }
  </script>
</MainLayout>
