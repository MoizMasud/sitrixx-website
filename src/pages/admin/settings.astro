---
import MainLayout from '../../layouts/main.astro';
import AdminLayout from '../../components/AdminLayout';
import { baseUrl } from '../../lib/base-url';
---

<MainLayout 
  title="Settings - Admin - Sitrixx"
  description="Admin settings"
>
  <AdminLayout client:load activePage="settings">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8">
        <h1 class="text-4xl font-black mb-2 tracking-tight">Settings</h1>
        <p class="text-muted-foreground">Configure your admin preferences and system settings</p>
      </div>

      <div class="bg-card border-2 rounded-2xl p-12 text-center">
        <div class="w-20 h-20 bg-muted rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold mb-2">Settings Coming Soon</h2>
        <p class="text-muted-foreground">
          This section will include system configuration, API keys, notification preferences, and more.
        </p>
      </div>
    </div>
  </AdminLayout>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Initialize Supabase Client -->
  <script>
    const { createClient } = window.supabase;
    const SUPABASE_URL = 'https://lmvymcncmmxtgfhkosmc.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_yeiYWuyhjZBBoSPcFRRKow__58efMlK';
    
    window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- authFetch Helper -->
  <script>
    const API_BASE = 'https://sitrixx-website-backend.vercel.app';

    /**
     * Wrap fetch to always send the Supabase JWT.
     * If there is no logged-in user, redirect to login.
     */
    async function authFetch(path, options = {}) {
      const supabase = window.supabaseClient;
      if (!supabase) {
        console.error('Supabase client not found');
        throw new Error('Supabase not initialized');
      }

      // Get current session
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error('Error getting session', error);
        throw error;
      }

      const session = data.session;
      if (!session) {
        // Not logged in â†’ bounce them to login page
        window.location.href = '/admin/login';
        throw new Error('Not authenticated');
      }

      const token = session.access_token;

      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {}),
        Authorization: `Bearer ${token}`,
      };

      return fetch(`${API_BASE}${path}`, {
        ...options,
        headers,
      });
    }

    // Expose globally so admin pages / custom code can call it
    window.authFetch = authFetch;
  </script>

  <!-- Authentication Guard Script -->
  <script define:vars={{ baseUrl }}>
    document.addEventListener('DOMContentLoaded', function () {
      const token = localStorage.getItem('sitrixx_token');
      if (!token) {
        window.location.href = baseUrl + '/admin/login';
      }
    });
  </script>
</MainLayout>
