---
import MainLayout from '../../layouts/main.astro';
import AdminLayout from '../../components/AdminLayout';
import LeadsPage from '../../components/LeadsPage';
import { baseUrl } from '../../lib/base-url';

const API_BASE = 'https://sitrixx-website-backend.vercel.app';

// Fetch clients server-side
let clientsData = {
  clients: [],
  error: null as string | null
};

try {
  const clientsRes = await fetch(`${API_BASE}/api/clients`);
  if (clientsRes.ok) {
    const data = await clientsRes.json();
    clientsData.clients = Array.isArray(data) ? data : (data.clients || []);
  } else {
    clientsData.error = 'Failed to load clients';
  }
} catch (err) {
  console.error('Error fetching clients:', err);
  clientsData.error = err instanceof Error ? err.message : 'Failed to load clients';
}
---

<MainLayout 
  title="Leads - Admin - Sitrixx"
  description="Manage incoming leads"
>
  <AdminLayout client:only="react" activePage="leads">
    {clientsData.error ? (
      <div class="max-w-7xl mx-auto">
        <div class="bg-destructive/10 border border-destructive/20 text-destructive px-4 py-3 rounded-lg">
          {clientsData.error}
        </div>
      </div>
    ) : (
      <LeadsPage client:only="react" clients={clientsData.clients} />
    )}
  </AdminLayout>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Authentication Guard Script -->
  <script define:vars={{ baseUrl }}>
    const token = localStorage.getItem('sitrixx_token');
    if (!token) {
      window.location.href = baseUrl + '/admin/login';
    }
  </script>

  <!-- Initialize Supabase and authFetch -->
  <script>
    // Wait for Supabase library to load
    function waitForSupabase(callback) {
      if (window.supabase && window.supabase.createClient) {
        callback();
      } else {
        console.log('â³ Waiting for Supabase library to load...');
        setTimeout(() => waitForSupabase(callback), 50);
      }
    }

    waitForSupabase(() => {
      console.log('âœ… Supabase library loaded');
      
      // Initialize Supabase Client
      const { createClient } = window.supabase;
      const SUPABASE_URL = 'https://lmvymcncmmxtgfhkosmc.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_yeiYWuyhjZBBoSPcFRRKow__58efMlK';
      
      console.log('ðŸ”§ Initializing Supabase client...');
      window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('âœ… Supabase client initialized');

      // Define authFetch
      const API_BASE = 'https://sitrixx-website-backend.vercel.app';

      /**
       * Wrap fetch to always send the Supabase JWT.
       * If there is no logged-in user, redirect to login.
       */
      async function authFetch(path, options = {}) {
        const supabase = window.supabaseClient;
        if (!supabase) {
          console.error('Supabase client not found');
          throw new Error('Supabase not initialized');
        }

        // Get current session
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('Error getting session', error);
          throw error;
        }

        const session = data.session;
        if (!session) {
          // Not logged in â†’ bounce them to login page
          window.location.href = '/admin/login';
          throw new Error('Not authenticated');
        }

        const token = session.access_token;

        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
          Authorization: `Bearer ${token}`,
        };

        return fetch(`${API_BASE}${path}`, {
          ...options,
          headers,
        });
      }

      // Expose globally
      window.authFetch = authFetch;
      console.log('âœ… authFetch helper initialized and ready');
    });
  </script>
</MainLayout>
